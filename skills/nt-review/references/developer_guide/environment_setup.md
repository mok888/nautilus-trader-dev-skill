# Environment Setup

For development we recommend using the PyCharm _Professional_ edition IDE, as it interprets Cython syntax. Alternatively, you could use Visual Studio Code with a Cython extension.

uv is the preferred tool for handling all Python virtual environments and dependencies.

pre-commit is used to automatically run various checks, auto-formatters and linting tools at commit.

NautilusTrader uses increasingly more Rust, so Rust should be installed on your system as well ([installation guide](https://www.rust-lang.org/tools/install)).

Cap'n Proto is required for serialization schema compilation. The required version is specified in the `capnp-version` file in the repository root. Ubuntu's default package is typically too old, so you may need to install from source (see below).

:::note
NautilusTrader _must_ compile and run on **Linux, macOS, and Windows**. Please keep portability in mind (use `std::path::Path`, avoid Bash-isms in shell scripts, etc.).
:::

## Setup Steps

The following steps are for UNIX-like systems, and only need to be completed once.

1. Follow the installation guide to set up the project with a modification to the final command to install development and test dependencies:

```bash
uv sync --active --all-groups --all-extras
```

or

If you're developing and iterating frequently, then compiling in debug mode is often sufficient and _significantly_ faster than a fully optimized build. To install in debug mode, use:

2. Set up the pre-commit hook which will then run automatically at commit:

Before opening a pull-request run the formatting and lint suite locally so that CI passes on the first attempt:

```bash
make format  
make pre-commit
```

Make sure the Rust compiler reports **zero errors** â€“ broken builds slow everyone down.

3. **Required for Rust/PyO3 (Linux and macOS)**: When using Python installed via `uv` on Linux or macOS, set the following environment variables:

```bash
# Add to your shell configuration (e.g., ~/.zshrc or ~/.bashrc)  
  
# Linux only: Set the library path for the Python interpreter  
export LD_LIBRARY_PATH="$(python -c 'import sys; print(sys.base_prefix)')/lib:$LD_LIBRARY_PATH"  
  
# Set the Python executable path for PyO3  
export PYO3_PYTHON=$(pwd)/.venv/bin/python  
  
# Set the Python home path (required for Rust tests)  
export PYTHONHOME=$(python -c "import sys; print(sys.base_prefix)")
```

:::note
The `LD_LIBRARY_PATH` export is Linux-specific and not needed on macOS or Windows.

- `PYO3_PYTHON` tells PyO3 which Python interpreter to use, reducing unnecessary recompilation.
- `PYTHONHOME` is required when running `make cargo-test` with a `uv`-installed Python. Without it, tests that depend on PyO3 may fail to locate the Python runtime.
:::

To verify your environment is configured correctly:

```bash
python -c "import sys; print('Python:', sys.executable, sys.version)"  
echo "PYO3_PYTHON: $PYO3_PYTHON"  
echo "PYTHONHOME: $PYTHONHOME"
```

Following any changes to `.rs`, `.pyx` or `.pxd` files, you can re-compile by running:

```bash
uv run --no-sync python build.py
```

or

If you're developing and iterating frequently, then compiling in debug mode is often sufficient and _significantly_ faster than a fully optimized build. To compile in debug mode, use:

## Cap'n Proto Installation

Cap'n Proto is required for serialization schema compilation. The required version is defined in the `capnp-version` file in the repository root.

### macOS

On **macOS**, install via Homebrew:

```bash
brew install capnp
capnp --version
```

Verify the installed version matches `capnp-version`. If Homebrew provides an older version, install from source using the Linux instructions below.

### Ubuntu/Linux

On **Ubuntu/Linux**, the default package is typically too old. Install from source:

```bash
CAPNP_VERSION=$(cat capnp-version)  
cd ~  
wget https://capnproto.org/capnproto-c++-${CAPNP_VERSION}.tar.gz  
tar xzf capnproto-c++-${CAPNP_VERSION}.tar.gz  
cd capnproto-c++-${CAPNP_VERSION}  
./configure  
make -j$(nproc)  
sudo make install  
sudo ldconfig
```

Verify installation:

```bash
capnp --version
```

### Windows

On **Windows**, install via Chocolatey:

```bash
choco install capnproto
capnp --version
```

Verify the installed version matches `capnp-version`. If Chocolatey provides an older version, see the [Cap'n Proto installation guide](https://capnproto.org/install.html) for alternative installation methods.

## Faster Rust Builds with Cranelift

The cranelift backends reduces build time significantly for dev, testing and IDE checks. However, cranelift is available on the nightly toolchain and needs extra configuration. Install the nightly toolchain:

```bash
rustup install nightly  
rustup override set nightly  
rustup component add rust-analyzer # install nightly lsp  
rustup override set stable # reset to stable
```

Activate the nightly feature and use "cranelift" backend for dev and testing profiles in workspace `Cargo.toml`. You can apply the below patch using `git apply <patch>`. You can remove it using `git apply -R <patch>` before pushing changes.

:::warning
Do not commit these changes. The cranelift patch is for local development only and will break CI if pushed.
:::

## Docker Development Environment

You can use `docker-compose.yml` file located in `.docker` directory to bootstrap the Nautilus working environment. This will start the following services:

If you only want specific services running (like `postgres` for example), you can start them with command:

```bash
docker-compose up -d postgres
```

Used services are:

- `postgres`: Postgres database with root user `POSTRES_USER` which defaults to `postgres`, `POSTGRES_PASSWORD` which defaults to `pass` and `POSTGRES_DB` which defaults to `postgres`.
- `redis`: Redis server.
- `pgadmin`: PgAdmin4 for database management and administration.

:::note
Please use this as development environment only. For production, use a proper and more secure setup.
:::

After the services has been started, you must log in with `psql` cli to create `nautilus` Postgres database. To do that you can run, and type `POSTGRES_PASSWORD` from docker service setup:

```bash
psql -h localhost -p 5432 -U postgres
```

After you have logged in as `postgres` administrator, run `CREATE DATABASE` command with target db name (we use `nautilus`):

```sql
psql (16.2, server 15.2 (Debian 15.2-1.pgdg110+1))  
Type "help" for help.  
  
postgres=# CREATE DATABASE nautilus;  
CREATE DATABASE
```

## Nautilus CLI

The Nautilus CLI is a command-line interface tool for interacting with the NautilusTrader ecosystem. It offers commands for managing the PostgreSQL database and handling various trading operations.

:::warning
On Linux systems with GNOME desktop, the `nautilus` command typically refers to the GNOME file manager (`/usr/bin/nautilus`). After installing the NautilusTrader CLI, you may need to ensure the Cargo binary takes precedence by either:

- Adding an alias to your shell config: `alias nautilus="$HOME/.cargo/bin/nautilus"`
- Using the full path: `~/.cargo/bin/nautilus`
- Ensuring `~/.cargo/bin` appears before `/usr/bin` in your `PATH`
:::

:::note
The Nautilus CLI command is only supported on UNIX-like systems.
:::

You can install the Nautilus CLI using the below Makefile target, which leverages `cargo install` under the hood. This will place the nautilus binary in your system's PATH, assuming Rust's `cargo` is properly configured.

```bash
make install-nautilus-cli
```

You can run `nautilus --help` to view the CLI structure and available command groups:

### Database

These commands handle bootstrapping the PostgreSQL database. To use them, you need to provide the correct connection configuration, either through command-line arguments or a `.env` file located in the root directory or the current working directory.

- `--host` or `POSTGRES_HOST` for the database host
- `--port` or `POSTGRES_PORT` for the database port
- `--user` or `POSTGRES_USERNAME` for the root administrator (typically the postgres user)
- `--password` or `POSTGRES_PASSWORD` for the root administrator's password
- `--database` or `POSTGRES_DATABASE` for both the database **name and the new user** with privileges to that database (e.g., if you provide `nautilus` as the value, a new user named nautilus will be created with the password from `POSTGRES_PASSWORD`, and the `nautilus` database will be bootstrapped with this user as the owner).

Example of `.env` file:

```env
POSTGRES_HOST=localhost  
POSTGRES_PORT=5432  
POSTGRES_USERNAME=postgres  
POSTGRES_PASSWORD=pass  
POSTGRES_DATABASE=nautilus
```

List of commands are:

1. `nautilus database init`: Will bootstrap schema, roles and all sql files located in `schema` root directory (like `tables.sql`).
2. `nautilus database drop`: Will drop all tables, roles and data in target Postgres database.

## IDE Configuration

Rust analyzer is a popular language server for Rust and has integrations for many IDEs. It is recommended to configure rust analyzer to have same environment variables as `make build-debug` for faster compile times. Below tested configurations for VSCode and Astro Nvim are provided.

### VSCode

You can add the following settings to your VSCode `settings.json` file:

```json
{
    "rust-analyzer.restartServerOnConfigChange": true,
    "rust-analyzer.linkedProjects": [
        "Cargo.toml"
    ],
    "rust-analyzer.cargo.features": "all",
    "rust-analyzer.check.workspace": false,
    "rust-analyzer.check.extraEnv": {
        "VIRTUAL_ENV": "<path-to-your-virtual-environment>/.venv",
        "CC": "clang",
        "CXX": "clang++"
    },
    "rust-analyzer.cargo.extraEnv": {
        "VIRTUAL_ENV": "<path-to-your-virtual-environment>/.venv",
        "CC": "clang",
        "CXX": "clang++"
    },
    "rust-analyzer.runnables.extraEnv": {
        "VIRTUAL_ENV": "<path-to-your-virtual-environment>/.venv",
        "CC": "clang",
        "CXX": "clang++"
    },
    "rust-analyzer.check.features": "all",
    "rust-analyzer.testExplorer": true
}
```

### Astro Nvim (Neovim + AstroLSP)

You can add the following to your astro lsp config file:

```lua
config = {
    rust_analyzer = {
        settings = {
            ["rust-analyzer"] = {
                restartServerOnConfigChange = true,
                linkedProjects = { "Cargo.toml" },
                cargo = {
                    features = "all",
                    extraEnv = {
                        VIRTUAL_ENV = "<path-to-your-virtual-environment>/.venv",
                        CC = "clang",
                        CXX = "clang++",
                    },
                },
                check = {
                    workspace = false,
                    command = "check",
                    features = "all",
                    extraEnv = {
                        VIRTUAL_ENV = "<path-to-your-virtual-environment>/.venv",
                        CC = "clang",
                        CXX = "clang++",
                    },
                },
                runnables = {
                    extraEnv = {
                        VIRTUAL_ENV = "<path-to-your-virtual-environment>/.venv",
                        CC = "clang",
                        CXX = "clang++",
                    },
                },
                testExplorer = true,
            },
        },
    },
}
```
